[TOC]





## 功能分析

- Java程序主动发送日志到指定位置
- 系统通过某种手段收集程序发送的日志
- 日志需要定时备份到文件
- 需要有查看实时日志的功能

---

## 技术难点分析

### 日志发送采用哪种方式?

  - 思路一：使用socket通信
      - 优点
          - 实现简单
        - 缺点
      - socket服务端横向扩展困难
      - 日志产生方和日志采集方耦合度过高
- 思路二：引入消息中间件作为通信桥梁，使用队列模式
  - 优点
    - 日志产生方和日志采集方解耦
    - 日志采集方可以横向扩展
  - 缺点
    - 采集的日志无法保证有序
    - 备份的日志文件依旧散乱
#### 解决方案

采用思路二



### 已有Java程序如何接入本系统

#### 解决方案

- 能够改动程序

  > 系统提供基于slf4j的工具类，只需要引入工具，修改项目配置文件即可接入系统
  >
  > **前提：Java程序使用slf4j作为日志框架**

- 不能或不愿改动程序

  > 系统提供基于文件监控的工具，只需要引入工具，修改工具配置即可接入本系统
  >
  > **前提：Java程序将日志输出到文件**

  **建议使用第一种方案**

---

### 如何保证日志消息有序

> 由于网络为不可靠资源，无法保证到达目的地顺序和发送顺序一致
> 且日志采集方采用横向扩展方案，代表同一段时间内的消息会被分散到多个机器，无法使用内存排序

#### 解决方案

> 引入时序数据库，日志采集方将采集到的日志存储到时序数据库，由时序数据库负责排序；日志采集方间隔一段时间再从数据库获取数据；以此保证在一定时间段内的日志消息有序。

---

### 如何实现实时日志浏览

> 目前日志采用的是消息中间件发送，使用queue模式；一旦日志消息被消费，则不能再次利用
> 且web模块采用B/S架构，常规B/S架构为半双工通信，无法实现S端推送消息到B端

#### 解决方案

- 日志采集方消费日志后再次将日志消息以topic模式发送给消息中间件
- web模块前端采用WebSocket与后端小链接
- web模块订阅消息中间件，一旦接收到日志消息，则通过WebSocket广播到前端



---

###  如何备份及下载日志文件

#### 解决方案

- 日志采集方定期从时序数据库抓取数据备份到本地服务器

- web模块通过socket与日志采集方通信，获取文件列表及文本流

  ![文件下载流程图](https://github.com/inkroom/log-colleage/blob/master/%E6%96%87%E6%A1%A3/%e6%9e%b6%e6%9e%84%e5%9b%be-%e6%96%87%e4%bb%b6%e4%b8%8b%e8%bd%bd%e6%b5%81%e7%a8%8b%e5%9b%be.jpg?raw=true)

---

### 如何降低耦合度

#### 耦合度来源

- 对于消息中间件的依赖——如果实现中大量使用ActiveMQ独有代码，将会导致无法替换消息中间件
- 对于时序数据库的依赖

#### 解决方案

- 消息中间件依赖

  > 采用工厂模式，定义消息中间件发送、接收等操作等接口规范；只要提供实现了该规范的依赖文件，即可实现消息中间件替换

- 时序数据库依赖

  > 时序数据库遵循jdbc标准，只要代码中不涉及某个时序数据库独有的操作，即可轻松替换时序数据库

## 项目结构

~~~
root
|--client 为Java程序提供的日志发送工具
|--platform-api 微信小程序商城api接口
|--platform-common 公共模块
|--platform-framework 系统WEB合并，请打包发布此项目
|--platform-gen 代码生成
|--platform-mp 微信公众号模块
|--platform-schedule 定时任务
|--platform-shop 商城后台管理
|--wx-mall 微信小程序商城
|--platform-vue 微信公众号商城（待开发）
~~~
